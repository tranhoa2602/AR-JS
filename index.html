<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover"
    />
    <meta name="theme-color" content="#0b0c10" />
    <title>Robot AR ‚Äî WebXR first (zoom/move)</title>

    <!-- model-viewer official -->
    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"
    ></script>

    <style>
      :root {
        color-scheme: dark;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: #0b0c10;
        color: #fff;
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", Arial;
      }
      .wrap {
        position: relative;
        height: 100vh;
        overflow: hidden;
      }

      model-viewer {
        width: 100%;
        height: 100%;
        display: block;
        background: #0b0c10;
        --poster-color: #0b0c10;
      }

      /* AR button */
      button[slot="ar-button"] {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 72px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        background: #ffe66d;
        color: #1b1e23;
        box-shadow: 0 6px 20px rgba(255, 230, 109, 0.35);
        z-index: 60;
      }
      button[slot="ar-button"]:active {
        transform: translateX(-50%) scale(0.97);
      }

      /* audio controls */
      .audio-controls {
        position: absolute;
        bottom: 92px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        align-items: center;
        background: rgba(255, 255, 255, 0.04);
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        z-index: 60;
      }
      .audio-controls button {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #fff;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
      }
      .notice {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 8px 12px;
        border-radius: 10px;
        z-index: 60;
        font-size: 13px;
      }
      .hidden {
        display: none !important;
      }
      .hint {
        position: absolute;
        right: 12px;
        bottom: 12px;
        background: rgba(255, 255, 255, 0.04);
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 60;
        border: 1px solid rgba(255, 255, 255, 0.06);
        color: #ddd;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div id="notice" class="notice hidden">üîé Ki·ªÉm tra AR...</div>

      <!-- model-viewer: defaults allow camera-controls for web view,
         ar-scale="auto" + ar-placement="floor" ƒë·ªÉ h·ªó tr·ª£ pinch/placement trong WebXR/Scene Viewer -->
      <model-viewer
        id="mv"
        src="https://modelviewer.dev/shared-assets/models/RobotExpressive.glb"
        ios-src="https://raw.githubusercontent.com/tranhoa2602/AR-JS/main/Kawasaki_Ninja_H2.usdz"
        alt="Model c·ªßa b·∫°n"
        ar
        ar-modes="webxr scene-viewer quick-look"
        ar-scale="auto"
        ar-placement="floor"
        camera-controls
        exposure="1"
        shadow-intensity="1"
        shadow-softness="0.6"
        autoplay
        tone-mapping="aces"
        interaction-prompt="auto"
        reveal="interaction"
      >
        <button slot="ar-button" id="arBtn" aria-label="M·ªü AR">
          üöÄ Xem trong AR
        </button>
      </model-viewer>

      <div class="audio-controls" id="audioControls">
        <button id="playBtn">‚ñ∂Ô∏è Play nh·∫°c</button>
        <button id="pauseBtn">‚è∏Ô∏è Pause</button>
        <span
          id="audioState"
          style="font-size: 13px; opacity: 0.95; margin-left: 6px"
          >T·∫Øt</span
        >
      </div>

      <div class="hint">
        H∆∞·ªõng d·∫´n: pinch ƒë·ªÉ ph√≥ng to/thu nh·ªè (trong WebXR/Scene Viewer), tap ƒë·ªÉ
        ƒë·∫∑t l·∫°i v·ªã tr√≠.
      </div>
    </div>

    <!-- Thay b·∫±ng music.mp3 c·ªßa b·∫°n (c√πng th∆∞ m·ª•c) ho·∫∑c URL HTTPS -->
    <audio id="bgm" src="music.mp3" preload="auto" loop></audio>

    <script>
      (function () {
        const mv = document.getElementById("mv");
        const bgm = document.getElementById("bgm");
        const notice = document.getElementById("notice");
        const arBtn = document.getElementById("arBtn");
        const playBtn = document.getElementById("playBtn");
        const pauseBtn = document.getElementById("pauseBtn");
        const audioState = document.getElementById("audioState");

        const iosSrcUrl = mv.getAttribute("ios-src"); // gi·ªØ ƒë·ªÉ fallback n·∫øu c·∫ßn

        const isSecure = () =>
          location.protocol === "https:" || location.hostname === "localhost";
        const isIOS = () =>
          /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        function show(msg, ms = 2600) {
          notice.textContent = msg;
          notice.classList.remove("hidden");
          clearTimeout(show._t);
          show._t = setTimeout(() => notice.classList.add("hidden"), ms);
        }

        if (!isSecure()) {
          show("‚ö†Ô∏è Vui l√≤ng ch·∫°y tr√™n HTTPS ho·∫∑c localhost ƒë·ªÉ d√πng AR.");
        } else {
          show("üîé Ki·ªÉm tra WebXR support‚Ä¶", 1200);
        }

        // --- Ph√°t hi·ªán WebXR immersive-ar support ---
        async function detectAndConfigure() {
          let xrSupported = false;
          try {
            if (
              navigator.xr &&
              typeof navigator.xr.isSessionSupported === "function"
            ) {
              xrSupported = await navigator.xr.isSessionSupported(
                "immersive-ar"
              );
            }
          } catch (e) {
            xrSupported = false;
          }

          // N·∫øu WebXR h·ªó tr·ª£, ∆∞u ti√™n WebXR: lo·∫°i b·ªè ios-src ƒë·ªÉ tr√°nh Quick Look (USDZ) override tr√™n iOS
          // v√† ƒë·∫∑t ar-modes ƒë·ªÉ ∆∞u ti√™n webxr.
          if (xrSupported) {
            show(
              "‚úÖ Thi·∫øt b·ªã h·ªó tr·ª£ WebXR ‚Äî ∆∞u ti√™n WebXR (zoom + move ho·∫°t ƒë·ªông).",
              2600
            );
            try {
              // Set attribute ƒë·ªÉ model-viewer ∆∞u ti√™n webxr
              mv.setAttribute("ar-modes", "webxr scene-viewer");
              // Remove ios-src so Quick Look won't be forced on iOS (if it was present)
              if (mv.hasAttribute("ios-src")) mv.removeAttribute("ios-src");
            } catch (e) {
              console.warn("config webxr:", e);
            }
          } else {
            // Kh√¥ng c√≥ webxr: fallback -> keep ios-src so Quick Look v·∫´n c√≥ th·ªÉ m·ªü tr√™n iOS
            show(
              "‚ÑπÔ∏è WebXR kh√¥ng c√≥ tr√™n thi·∫øt b·ªã n√†y. S·ª≠ d·ª•ng Quick Look / Scene Viewer (n·∫øu c√≥).",
              4200
            );
            try {
              mv.setAttribute("ar-modes", "scene-viewer quick-look");
              if (iosSrcUrl) mv.setAttribute("ios-src", iosSrcUrl);
            } catch (e) {
              console.warn("config fallback:", e);
            }
          }
        }

        // ch·∫°y detect tr∆∞·ªõc khi user click (s·ªõm)
        detectAndConfigure();

        // --- animation default n·∫øu file c√≥ animation ---
        mv.addEventListener("load", () => {
          try {
            const anims = mv.availableAnimations || [];
            if (anims.length) {
              const chosen = anims.includes("Dance") ? "Dance" : anims[0];
              mv.animationName = chosen;
              mv.loop = true;
              mv.timeScale = 1;
              if (typeof mv.play === "function") mv.play();
            }
          } catch (e) {
            console.warn("animation init", e);
          }
        });

        // --- Audio controls + autoplay policy handling ---
        function setAudioState(text) {
          audioState.textContent = text;
        }

        async function tryUnlockAudio() {
          try {
            await bgm.play();
            bgm.pause();
            bgm.currentTime = 0;
            setAudioState("S·∫µn s√†ng");
            return true;
          } catch (e) {
            setAudioState("B·ªã ch·∫∑n");
            return false;
          }
        }

        playBtn.addEventListener("click", async () => {
          try {
            await bgm.play();
            setAudioState("ƒêang ph√°t");
          } catch {
            setAudioState("B·ªã ch·∫∑n");
            await tryUnlockAudio();
          }
        });
        pauseBtn.addEventListener("click", () => {
          bgm.pause();
          setAudioState("T·∫°m d·ª´ng");
        });

        // khi b·∫•m AR button: c·ªë g·∫Øng play audio tr√™n gesture c·ªßa ng∆∞·ªùi d√πng
        arBtn.addEventListener("click", async () => {
          try {
            await bgm.play();
            setAudioState("ƒêang ph√°t");
          } catch (err) {
            console.log("[AR] audio blocked, trying unlock", err);
            await tryUnlockAudio();
            if (isIOS()) {
              show(
                "üì≤ iOS Quick Look th∆∞·ªùng kh√¥ng cho nh·∫°c web ch·∫°y trong AR (gi·ªõi h·∫°n n·ªÅn t·∫£ng).",
                4200
              );
            } else {
              show("üîä N·∫øu nh·∫°c kh√¥ng ph√°t, nh·∫•n Play.", 3000);
            }
          }
          // model-viewer t·ª± x·ª≠ l√Ω m·ªü AR (WebXR/SceneViewer/QuickLook) khi n√∫t n√†y ƒë∆∞·ª£c b·∫•m
        });

        // Khi ar-status thay ƒë·ªïi (b·∫Øt ƒë·∫ßu session): ƒë·∫£m b·∫£o play
        mv.addEventListener("ar-status", (e) => {
          const s = e?.detail?.status;
          if (s === "session-started") {
            if (navigator.vibrate) navigator.vibrate(20);
            bgm.currentTime = 0;
            bgm
              .play()
              .then(() => setAudioState("ƒêang ph√°t"))
              .catch(() => setAudioState("B·ªã ch·∫∑n"));
          } else if (s === "not-presenting" || s === "failed") {
            try {
              bgm.pause();
              bgm.currentTime = 0;
              setAudioState("T·∫Øt");
            } catch (e) {}
          }
        });

        // Pause when hidden
        document.addEventListener("visibilitychange", () => {
          if (document.hidden) {
            try {
              bgm.pause();
              setAudioState("T·∫°m d·ª´ng");
            } catch (e) {}
          }
        });

        // Error handler
        mv.addEventListener("error", (e) => {
          console.warn("[model-viewer] error:", e?.detail || e);
          show("‚ö†Ô∏è L·ªói model-viewer. Xem console ƒë·ªÉ bi·∫øt chi ti·∫øt.", 4000);
        });

        // fallback unlock on first pointerdown
        (function oneTimeUnlock() {
          const handler = async () => {
            await tryUnlockAudio();
            window.removeEventListener("pointerdown", handler, {
              capture: true,
            });
          };
          window.addEventListener("pointerdown", handler, {
            capture: true,
            once: true,
          });
        })();

        setAudioState("T·∫Øt");
      })();
    </script>
  </body>
</html>
