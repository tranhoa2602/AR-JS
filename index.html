<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <meta name="theme-color" content="#0b0c10" />
    <title>Robot AR + Sound (Kenh14.vn)</title>

    <!-- model-viewer -->
    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"
    ></script>

    <style>
      :root {
        color-scheme: dark;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: #0b0c10;
        color: #fff;
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", Arial;
      }
      .wrap {
        position: relative;
        height: 100vh;
        overflow: hidden;
      }

      model-viewer {
        width: 100%;
        height: 100%;
        display: block;
        background: #0b0c10;
        --poster-color: #0b0c10;
      }

      /* AR button */
      button[slot="ar-button"] {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 80px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        background: #ffe66d;
        color: #1b1e23;
        box-shadow: 0 6px 20px rgba(255, 230, 109, 0.35);
        z-index: 60;
      }
      button[slot="ar-button"]:active {
        transform: translateX(-50%) scale(0.97);
      }

      /* Audio controls */
      .audio-controls {
        position: absolute;
        bottom: 92px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        align-items: center;
        background: rgba(255, 255, 255, 0.04);
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        backdrop-filter: blur(6px);
        z-index: 60;
      }
      .audio-controls button {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #fff;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
      }
      .audio-controls button:active {
        transform: scale(0.98);
      }

      /* Notice */
      .notice {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 8px 12px;
        border-radius: 10px;
        backdrop-filter: blur(8px);
        font-size: 13px;
        line-height: 1.2;
        z-index: 60;
      }
      .hidden {
        display: none !important;
      }

      /* Small hint box */
      .hint {
        position: absolute;
        right: 12px;
        bottom: 12px;
        background: rgba(255, 255, 255, 0.04);
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 60;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      /* Make images inside call-to-action responsive (if used) */
      a[rel="ar"] img {
        max-width: 160px;
        display: block;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div id="notice" class="notice hidden">üîé ƒêang ki·ªÉm tra h·ªó tr·ª£ AR‚Ä¶</div>
      <model-viewer
        id="mv"
        src="https://modelviewer.dev/shared-assets/models/RobotExpressive.glb"
        ios-src="https://github.com/tranhoa2602/AR-JS/blob/main/Kawasaki_Ninja_H2.usdz"
        alt="Robot Expressive"
        ar
        ar-modes="webxr scene-viewer quick-look"
        ar-scale="auto"
        ar-placement="floor"
        camera-controls
        exposure="1"
        shadow-intensity="1"
        shadow-softness="0.6"
        autoplay
        tone-mapping="aces"
        interaction-prompt="auto"
        reveal="interaction"
      >
        <button slot="ar-button" id="arBtn" aria-label="M·ªü AR">
          üöÄ Xem trong AR
        </button>
      </model-viewer>

      <!-- Audio controls -->
      <div class="audio-controls" id="audioControls" aria-hidden="false">
        <button id="playBtn" type="button">‚ñ∂Ô∏è Play nh·∫°c</button>
        <button id="pauseBtn" type="button">‚è∏Ô∏è Pause</button>
        <span
          id="audioState"
          style="font-size: 13px; opacity: 0.95; margin-left: 6px"
          >T·∫Øt</span
        >
      </div>

      <div class="hint">
        H∆∞·ªõng d·∫´n: pinch ƒë·ªÉ ph√≥ng to/thu nh·ªè, tap ƒë·ªÉ di chuy·ªÉn tr√™n m·∫∑t ph·∫≥ng.
      </div>
    </div>

    <!-- NH·∫†C: n·∫øu ƒë·∫∑t file music.mp3 c√πng th∆∞ m·ª•c ho·∫∑c ƒë·ªïi th√†nh URL HTTPS -->
    <audio id="bgm" src="music.mp3" preload="auto" loop></audio>

    <script>
      (function () {
        const mv = document.getElementById("mv");
        const bgm = document.getElementById("bgm");
        const notice = document.getElementById("notice");
        const arBtn = document.getElementById("arBtn");
        const playBtn = document.getElementById("playBtn");
        const pauseBtn = document.getElementById("pauseBtn");
        const audioState = document.getElementById("audioState");

        const isSecure = () =>
          location.protocol === "https:" || location.hostname === "localhost";
        const isIOS = () =>
          /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        function show(msg, ms = 2200) {
          notice.textContent = msg;
          notice.classList.remove("hidden");
          clearTimeout(show._t);
          show._t = setTimeout(() => notice.classList.add("hidden"), ms);
        }

        // Check env
        if (!isSecure()) {
          show("‚ö†Ô∏è H√£y ch·∫°y tr√™n HTTPS (ho·∫∑c localhost) ƒë·ªÉ b·∫≠t AR.");
        } else {
          show(
            "‚úÖ Thi·∫øt b·ªã s·∫µn s√†ng. Nh·∫•n ‚ÄúXem trong AR‚Äù ho·∫∑c Play nh·∫°c.",
            2200
          );
        }

        // Play default animation (n·∫øu c√≥)
        mv.addEventListener("load", () => {
          try {
            const anims = mv.availableAnimations || [];
            if (anims.length) {
              const chosen = anims.includes("Dance") ? "Dance" : anims[0];
              mv.animationName = chosen;
              mv.loop = true;
              mv.timeScale = 1;
              if (typeof mv.play === "function") mv.play();
            }
          } catch (e) {
            console.warn("animation init error", e);
          }
        });

        // Audio state helper
        function setAudioState(text) {
          audioState.textContent = text;
        }

        // Try unlock audio once on first user gesture (fallback)
        function tryUnlockAudio() {
          return bgm
            .play()
            .then(() => {
              bgm.pause();
              bgm.currentTime = 0;
              setAudioState("S·∫µn s√†ng");
              return true;
            })
            .catch(() => {
              setAudioState("B·ªã ch·∫∑n");
              return false;
            });
        }

        // Play / Pause buttons
        playBtn.addEventListener("click", async () => {
          try {
            await bgm.play();
            setAudioState("ƒêang ph√°t");
          } catch {
            setAudioState("B·ªã ch·∫∑n");
            await tryUnlockAudio();
          }
        });
        pauseBtn.addEventListener("click", () => {
          bgm.pause();
          setAudioState("T·∫°m d·ª´ng");
        });

        // When AR button clicked: attempt to play audio on the same user gesture
        arBtn.addEventListener("click", async () => {
          try {
            await bgm.play();
            setAudioState("ƒêang ph√°t");
          } catch (err) {
            console.log("[AR] audio blocked, attempting unlock", err);
            await tryUnlockAudio();
            show(
              isIOS()
                ? "üì≤ iOS Quick Look kh√¥ng cho nh·∫°c web ch·∫°y trong AR."
                : "üîä N·∫øu nh·∫°c kh√¥ng ph√°t, nh·∫•n Play.",
              3000
            );
          }
          // model-viewer will open AR automatically after this click
        });

        // When AR session changes
        mv.addEventListener("ar-status", (e) => {
          const s = e?.detail?.status;
          if (s === "session-started") {
            if (navigator.vibrate) navigator.vibrate(20);
            bgm.currentTime = 0;
            bgm
              .play()
              .then(() => setAudioState("ƒêang ph√°t"))
              .catch(() => {
                console.log("[ar-status] audio blocked");
                setAudioState("B·ªã ch·∫∑n");
              });
          } else if (s === "not-presenting" || s === "failed") {
            try {
              bgm.pause();
              bgm.currentTime = 0;
              setAudioState("T·∫Øt");
            } catch (e) {}
          }
        });

        // Pause audio if tab hidden
        document.addEventListener("visibilitychange", () => {
          if (document.hidden) {
            bgm.pause();
            setAudioState("T·∫°m d·ª´ng");
          }
        });

        // Errors
        mv.addEventListener("error", (e) => {
          console.warn("[model-viewer] error:", e?.detail || e);
          show("‚ö†Ô∏è L·ªói model-viewer. Xem console ƒë·ªÉ bi·∫øt chi ti·∫øt.", 4000);
        });

        // Fallback: try unlock on first pointerdown
        function oneTimeUnlockOnFirstTap() {
          const handler = async () => {
            await tryUnlockAudio();
            window.removeEventListener("pointerdown", handler, {
              capture: true,
            });
          };
          window.addEventListener("pointerdown", handler, {
            capture: true,
            once: true,
          });
        }
        oneTimeUnlockOnFirstTap();
        setAudioState("T·∫Øt");
      })();
    </script>
  </body>
</html>
