<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover"
    />
    <meta name="theme-color" content="#0b0c10" />
    <title>AR Model ‚Äî Move & Pinch</title>

    <!-- model-viewer -->
    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"
    ></script>

    <style>
      :root {
        color-scheme: dark;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: #0b0c10;
        color: #fff;
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", Arial;
      }
      .wrap {
        position: relative;
        height: 100vh;
        overflow: hidden;
      }
      model-viewer {
        width: 100%;
        height: 100%;
        display: block;
        background: #0b0c10;
        --poster-color: #0b0c10;
      }
      /* AR button */
      button[slot="ar-button"] {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 72px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        background: #ffe66d;
        color: #1b1e23;
        box-shadow: 0 6px 20px rgba(255, 230, 109, 0.35);
        z-index: 60;
      }
      button[slot="ar-button"]:active {
        transform: translateX(-50%) scale(0.97);
      }
      /* audio controls */
      .audio-controls {
        position: absolute;
        bottom: 92px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        align-items: center;
        background: rgba(255, 255, 255, 0.04);
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        z-index: 60;
      }
      .audio-controls button {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #fff;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
      }
      .notice {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 8px 12px;
        border-radius: 10px;
        z-index: 60;
        font-size: 13px;
      }
      .hidden {
        display: none !important;
      }
      .hint {
        position: absolute;
        right: 12px;
        bottom: 12px;
        background: rgba(255, 255, 255, 0.04);
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 60;
        border: 1px solid rgba(255, 255, 255, 0.06);
        color: #ddd;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div id="notice" class="notice hidden">üîé Ki·ªÉm tra AR...</div>

      <!-- model-viewer:
         - ar-scale="auto" ƒë·ªÉ cho ph√©p pinch trong AR.
         - ar-placement="floor" ƒë·ªÉ tap ƒë·∫∑t model tr√™n m·∫∑t ph·∫≥ng.
         - scale="0.18 0.18 0.18" l√†m model nh·ªè khi xu·∫•t hi·ªán. (ch·ªânh theo mu·ªën)
    -->
      <model-viewer
        id="mv"
        src="https://modelviewer.dev/shared-assets/models/RobotExpressive.glb"
        ios-src="https://raw.githubusercontent.com/tranhoa2602/AR-JS/main/Chibi_Ripper.usdz"
        alt="Model c·ªßa b·∫°n"
        ar
        ar-modes="webxr scene-viewer quick-look"
        ar-scale="auto"
        ar-placement="floor"
        camera-controls
        exposure="1"
        shadow-intensity="1"
        shadow-softness="0.6"
        autoplay
        tone-mapping="aces"
        interaction-prompt="auto"
        reveal="interaction"
        scale="0.18 0.18 0.18"
        camera-orbit="0deg 75deg 2.2m"
      >
        <button slot="ar-button" id="arBtn" aria-label="M·ªü AR">
          üöÄ Xem trong AR
        </button>
      </model-viewer>

      <div class="audio-controls" id="audioControls">
        <button id="playBtn">‚ñ∂Ô∏è Play nh·∫°c</button>
        <button id="pauseBtn">‚è∏Ô∏è Pause</button>
        <span
          id="audioState"
          style="font-size: 13px; opacity: 0.95; margin-left: 6px"
          >T·∫Øt</span
        >
      </div>

      <div class="hint">
        H∆∞·ªõng d·∫´n: pinch ƒë·ªÉ ph√≥ng to/thu nh·ªè (AR/Web), ch·∫°m & vu·ªët ƒë·ªÉ xoay/di
        chuy·ªÉn g√≥c nh√¨n (trong web). Tap ƒë·ªÉ ƒë·∫∑t model tr√™n m·∫∑t ph·∫≥ng khi v√†o AR.
      </div>
    </div>

    <!-- NH·∫†C: ƒë·ªïi ƒë∆∞·ªùng d·∫´n music.mp3 n·∫øu c·∫ßn -->
    <audio id="bgm" src="music.mp3" preload="auto" loop></audio>

    <script>
      (function () {
        const mv = document.getElementById("mv");
        const bgm = document.getElementById("bgm");
        const notice = document.getElementById("notice");
        const arBtn = document.getElementById("arBtn");
        const playBtn = document.getElementById("playBtn");
        const pauseBtn = document.getElementById("pauseBtn");
        const audioState = document.getElementById("audioState");

        const isSecure = () =>
          location.protocol === "https:" || location.hostname === "localhost";
        const isIOS = () =>
          /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        function show(msg, ms = 2200) {
          notice.textContent = msg;
          notice.classList.remove("hidden");
          clearTimeout(show._t);
          show._t = setTimeout(() => notice.classList.add("hidden"), ms);
        }

        if (!isSecure()) {
          show("‚ö†Ô∏è Ch·∫°y tr√™n HTTPS ho·∫∑c localhost ƒë·ªÉ d√πng AR.");
        } else {
          show("üîé Ki·ªÉm tra WebXR support‚Ä¶", 1200);
        }

        // --- Audio controls ---
        function setAudioState(text) {
          audioState.textContent = text;
        }
        playBtn.addEventListener("click", async () => {
          try {
            await bgm.play();
            setAudioState("ƒêang ph√°t");
          } catch {
            setAudioState("B·ªã ch·∫∑n");
          }
        });
        pauseBtn.addEventListener("click", () => {
          bgm.pause();
          setAudioState("T·∫°m d·ª´ng");
        });

        // Khi b·∫•m AR: c·ªë g·∫Øng play tr√™n gesture
        arBtn.addEventListener("click", async () => {
          try {
            await bgm.play();
            setAudioState("ƒêang ph√°t");
          } catch (e) {
            setAudioState("B·ªã ch·∫∑n");
            if (isIOS())
              show("üì≤ iOS Quick Look c√≥ gi·ªõi h·∫°n √¢m thanh trong AR.", 4200);
          }
          // model-viewer t·ª± m·ªü AR sau click
        });

        // Khi session AR thay ƒë·ªïi: play/d·ª´ng t∆∞∆°ng ·ª©ng
        mv.addEventListener("ar-status", (e) => {
          const s = e?.detail?.status;
          if (s === "session-started") {
            if (navigator.vibrate) navigator.vibrate(20);
            bgm.currentTime = 0;
            bgm
              .play()
              .then(() => setAudioState("ƒêang ph√°t"))
              .catch(() => setAudioState("B·ªã ch·∫∑n"));
          } else if (s === "not-presenting" || s === "failed") {
            try {
              bgm.pause();
              bgm.currentTime = 0;
              setAudioState("T·∫Øt");
            } catch (_) {}
          }
        });

        // Pause khi tab ·∫©n
        document.addEventListener("visibilitychange", () => {
          if (document.hidden) {
            try {
              bgm.pause();
              setAudioState("T·∫°m d·ª´ng");
            } catch (_) {}
          }
        });

        // --- Web view gestures: rotate & pinch -> update camera-orbit (simulates move+zoom) ---
        // This only runs in non-AR web view; in AR the platform gestures handle placement/scale.
        let pointers = new Map();
        let lastDist = null;
        let isInAR = false;

        mv.addEventListener("ar-status", (e) => {
          const s = e?.detail?.status;
          isInAR = s === "session-started";
        });

        // parse camera-orbit like "0deg 75deg 2.2m"
        function parseOrbit(str) {
          const parts = (str || "0deg 75deg 2.2m").split(/\s+/);
          const az = parseFloat(parts[0].replace("deg", "")) || 0;
          const el = parseFloat(parts[1].replace("deg", "")) || 75;
          const r = parseFloat(parts[2].replace("m", "")) || 2.2;
          return { az, el, r };
        }
        function formatOrbit(o) {
          return `${o.az}deg ${o.el}deg ${o.r}m`;
        }

        // clamp helpers
        function clamp(v, min, max) {
          return Math.max(min, Math.min(max, v));
        }

        // initialize orbit from attribute
        let orbit = parseOrbit(
          mv.getAttribute("camera-orbit") || "0deg 75deg 2.2m"
        );

        // apply initial orbit to model-viewer
        mv.setAttribute("camera-orbit", formatOrbit(orbit));

        // pointer events on model-viewer (non-AR)
        mv.addEventListener(
          "pointerdown",
          (ev) => {
            // if in AR session, don't intercept gestures
            if (isInAR) return;
            pointers.set(ev.pointerId, { x: ev.clientX, y: ev.clientY });
            mv.setPointerCapture?.(ev.pointerId);
            if (pointers.size === 2) {
              // start pinch
              const pts = Array.from(pointers.values());
              lastDist = Math.hypot(pts[0].x - pts[1].x, pts[0].y - pts[1].y);
            }
          },
          { passive: false }
        );

        mv.addEventListener(
          "pointermove",
          (ev) => {
            if (isInAR) return;
            if (!pointers.has(ev.pointerId)) return;
            // update pointer
            const data = pointers.get(ev.pointerId);
            const prevX = data.x,
              prevY = data.y;
            const curX = ev.clientX,
              curY = ev.clientY;
            pointers.set(ev.pointerId, { x: curX, y: curY });

            if (pointers.size === 1) {
              // rotate orbit by drag
              const dx = curX - prevX;
              const dy = curY - prevY;
              const azDelta = dx * 0.1; // sensitivity adjust
              const elDelta = dy * 0.08;
              orbit.az = (orbit.az - azDelta) % 360;
              orbit.el = clamp(orbit.el - elDelta, -85, 85);
              mv.setAttribute("camera-orbit", formatOrbit(orbit));
            } else if (pointers.size === 2) {
              // pinch: compute distance
              const pts = Array.from(pointers.values());
              const dist = Math.hypot(pts[0].x - pts[1].x, pts[0].y - pts[1].y);
              if (lastDist) {
                const delta = dist - lastDist;
                // adjust radius by delta (sensitivity)
                const factor = 0.01; // tweak for speed
                orbit.r = clamp(orbit.r - delta * factor, 0.3, 10.0);
                mv.setAttribute("camera-orbit", formatOrbit(orbit));
              }
              lastDist = dist;
            }
          },
          { passive: false }
        );

        function releasePointer(id) {
          try {
            mv.releasePointerCapture?.(id);
          } catch (_) {}
          pointers.delete(id);
          if (pointers.size < 2) lastDist = null;
        }

        mv.addEventListener(
          "pointerup",
          (ev) => {
            releasePointer(ev.pointerId);
          },
          { passive: true }
        );
        mv.addEventListener(
          "pointercancel",
          (ev) => {
            releasePointer(ev.pointerId);
          },
          { passive: true }
        );
        mv.addEventListener(
          "lostpointercapture",
          (ev) => {
            releasePointer(ev.pointerId);
          },
          { passive: true }
        );

        // wheel zoom for desktop
        mv.addEventListener(
          "wheel",
          (ev) => {
            if (isInAR) return;
            ev.preventDefault();
            const delta = ev.deltaY;
            orbit.r = clamp(orbit.r + delta * 0.01, 0.3, 10.0);
            mv.setAttribute("camera-orbit", formatOrbit(orbit));
          },
          { passive: false }
        );

        // Attempt to unlock audio on first user tap anywhere
        window.addEventListener(
          "pointerdown",
          async function oneTime() {
            try {
              await bgm.play();
              bgm.pause();
              bgm.currentTime = 0;
              setAudioState("S·∫µn s√†ng");
            } catch (e) {
              /*ignored*/
            }
            window.removeEventListener("pointerdown", oneTime, {
              capture: true,
            });
          },
          { capture: true, once: true }
        );

        // helper to update audio state text
        function setAudioState(txt) {
          audioState.textContent = txt;
        }

        // Error handling
        mv.addEventListener("error", (e) => {
          console.warn("[model-viewer] error:", e?.detail || e);
          show("‚ö†Ô∏è L·ªói model-viewer. M·ªü console ƒë·ªÉ xem chi ti·∫øt.", 4000);
        });

        // initial audio text
        setAudioState("T·∫Øt");
      })();
    </script>
  </body>
</html>
