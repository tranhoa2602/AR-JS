<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover"
    />
    <meta name="theme-color" content="#0b0c10" />
    <title>AR Model + Nh·∫°c</title>

    <!-- model-viewer -->
    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"
    ></script>

    <style>
      :root {
        color-scheme: dark;
      }
      body {
        margin: 0;
        background: #0b0c10;
        color: #fff;
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", Arial;
      }
      .wrap {
        position: relative;
        height: 100vh;
        overflow: hidden;
      }

      model-viewer {
        width: 100%;
        height: 100%;
        display: block;
        background: #0b0c10;
        --poster-color: #0b0c10;
      }

      /* N√∫t AR */
      button[slot="ar-button"] {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 72px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        background: #ffe66d;
        color: #1b1e23;
        box-shadow: 0 6px 20px rgba(255, 230, 109, 0.35);
        z-index: 60;
      }
      button[slot="ar-button"]:active {
        transform: translateX(-50%) scale(0.97);
      }

      /* Audio controls */
      .audio-controls {
        position: absolute;
        bottom: 92px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        align-items: center;
        background: rgba(255, 255, 255, 0.04);
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        z-index: 60;
      }
      .audio-controls button {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #fff;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
      }
      .notice {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 8px 12px;
        border-radius: 10px;
        z-index: 60;
        font-size: 13px;
      }
      .hidden {
        display: none !important;
      }
      .hint {
        position: absolute;
        right: 12px;
        bottom: 12px;
        background: rgba(255, 255, 255, 0.04);
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 60;
        border: 1px solid rgba(255, 255, 255, 0.06);
        color: #ddd;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div id="notice" class="notice hidden">üîé Ki·ªÉm tra AR...</div>

      <!-- model-viewer -->
      <model-viewer
        id="mv"
        src="https://modelviewer.dev/shared-assets/models/RobotExpressive.glb"
        ios-src="https://raw.githubusercontent.com/tranhoa2602/AR-JS/main/Kawasaki_Ninja_H2.usdz"
        alt="M√¥ h√¨nh AR"
        ar
        ar-modes="webxr scene-viewer quick-look"
        ar-scale="auto"
        ar-placement="floor"
        camera-controls
        exposure="1"
        shadow-intensity="1"
        shadow-softness="0.6"
        autoplay
        tone-mapping="aces"
        interaction-prompt="auto"
        reveal="interaction"
      >
        <button slot="ar-button" id="arBtn" aria-label="M·ªü AR">
          üöÄ Xem trong AR
        </button>
      </model-viewer>

      <!-- Audio control -->
      <div class="audio-controls" id="audioControls">
        <button id="playBtn">‚ñ∂Ô∏è Play nh·∫°c</button>
        <button id="pauseBtn">‚è∏Ô∏è Pause</button>
        <span
          id="audioState"
          style="font-size: 13px; opacity: 0.95; margin-left: 6px"
          >T·∫Øt</span
        >
      </div>

      <div class="hint">
        üëâ Pinch ƒë·ªÉ ph√≥ng to/thu nh·ªè, tap ƒë·ªÉ di chuy·ªÉn trong AR.
      </div>
    </div>

    <!-- Nh·∫°c n·ªÅn -->
    <audio id="bgm" src="music.mp3" preload="auto" loop></audio>

    <script>
      (function () {
        const mv = document.getElementById("mv");
        const bgm = document.getElementById("bgm");
        const notice = document.getElementById("notice");
        const arBtn = document.getElementById("arBtn");
        const playBtn = document.getElementById("playBtn");
        const pauseBtn = document.getElementById("pauseBtn");
        const audioState = document.getElementById("audioState");

        const iosSrcUrl = mv.getAttribute("ios-src");

        const isSecure = () =>
          location.protocol === "https:" || location.hostname === "localhost";
        const isIOS = () =>
          /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        function show(msg, ms = 2600) {
          notice.textContent = msg;
          notice.classList.remove("hidden");
          clearTimeout(show._t);
          show._t = setTimeout(() => notice.classList.add("hidden"), ms);
        }

        // ‚úÖ Detect WebXR
        async function detectAndConfigure() {
          let xrSupported = false;
          try {
            if (navigator.xr?.isSessionSupported) {
              xrSupported = await navigator.xr.isSessionSupported(
                "immersive-ar"
              );
            }
          } catch (e) {
            xrSupported = false;
          }

          if (xrSupported) {
            show("‚úÖ Thi·∫øt b·ªã h·ªó tr·ª£ WebXR ‚Äî ∆∞u ti√™n WebXR.", 2600);
            mv.setAttribute("ar-modes", "webxr scene-viewer");
            mv.removeAttribute("ios-src");
          } else {
            show("‚ÑπÔ∏è Kh√¥ng c√≥ WebXR. D√πng Scene Viewer/Quick Look.", 4200);
            mv.setAttribute("ar-modes", "scene-viewer quick-look");
            if (iosSrcUrl) mv.setAttribute("ios-src", iosSrcUrl);
          }
        }
        detectAndConfigure();

        // üéµ Audio controls
        function setAudioState(text) {
          audioState.textContent = text;
        }
        playBtn.addEventListener("click", () => {
          bgm.play().then(() => setAudioState("ƒêang ph√°t"));
        });
        pauseBtn.addEventListener("click", () => {
          bgm.pause();
          setAudioState("T·∫°m d·ª´ng");
        });

        // Khi b·∫•m AR ‚Üí b·∫≠t nh·∫°c
        arBtn.addEventListener("click", async () => {
          try {
            await bgm.play();
            setAudioState("ƒêang ph√°t");
          } catch {
            setAudioState("B·ªã ch·∫∑n");
            if (isIOS()) {
              show("üì≤ iOS Quick Look th∆∞·ªùng kh√¥ng cho ph√°t nh·∫°c.", 4200);
            }
          }
        });

        // Khi session AR thay ƒë·ªïi
        mv.addEventListener("ar-status", (e) => {
          const s = e.detail?.status;
          if (s === "session-started") {
            bgm.currentTime = 0;
            bgm.play().then(() => setAudioState("ƒêang ph√°t"));
          } else if (s === "not-presenting" || s === "failed") {
            bgm.pause();
            bgm.currentTime = 0;
            setAudioState("T·∫Øt");
          }
        });

        // ·∫®n tab ‚Üí pause nh·∫°c
        document.addEventListener("visibilitychange", () => {
          if (document.hidden) {
            bgm.pause();
            setAudioState("T·∫°m d·ª´ng");
          }
        });

        setAudioState("T·∫Øt");
      })();
    </script>
  </body>
</html>
